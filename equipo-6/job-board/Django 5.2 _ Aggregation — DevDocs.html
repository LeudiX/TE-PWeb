<!DOCTYPE html>
<!-- saved from url=(0051)https://devdocs.io/django~5.2/topics/db/aggregation -->
<html lang="en" class="_theme-dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="description" content="Django 5.2 API documentation with instant search, offline support, keyboard shortcuts, mobile version, and more.">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#1c1c1c">
  <meta property="og:image" content="/images/icon-320.png">
  <title _msttexthash="4183478" _msthash="0">Django 5.2 / Aggregation — DevDocs</title>
  <link rel="canonical" href="https://devdocs.io/django~5.2/topics/db/aggregation">
  <link rel="manifest" href="https://devdocs.io/manifest.json">
  <link rel="icon" type="image/x-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAABctJREFUWEfVl3tMU1ccx7+3vW1pK5DyKAWE8oiitYrIw0coIgzdqMORzTHntizOZDOa+Ng0YTGZi1tInG8zF+CP7Q9iRjQ+lsw4cY4EjZHyUByIiBakCCgv+4Q+7l3OYRDdqC0qS3aS5ibn3p7f53zP7/c95zAAUF5ePpPn+X08z2cDiCR909UkEgkXHBzcpVAo1mZnZxsYEpzjuJsAQqYr6GTjisViPj4+fjFTVlZ2guf5dUqlEmlpaQgMDJxWDovFgrq6Ojx69AhKpbKTKS0tfUhkz8/Pn/bg4zMjEOfPnwdZDgLAkxdFRUXTOvN/Dl5ZWUm7/h8AHo8HQ0NDaGhogNFoBJFQKBQiPDwcGo0GiYmJdPkEAoHfKvqtgMPhwK1bt9DY2EghGIahP9I4jqPPyMhIpKenIykpiYL50/wCGBkZQW1tLa5duwae5xESEoLQ0FDI5XIafHBwEAMDAyCQUqkUmZmZ0Gq1JLl8MvgEILITyS9fvkxnHBMTg6ysLISFhUEkElEgu92Ojo4OGAwGWlYksE6nQ2pq6oRK3kh8AvT39+P06dNU9tjYWBo8Ojr6X+MREAJRXV2Nvr4+ClpYWAiZTPZcFXwCXLx4kSpAZkw8IioqCvX3/8SvhipcabkOu8P+d4CxfCAg48+n82Tso7F3pF/IsIiQBiPcHYD5ijjvZVhaWorh4WGaWHq9nsp+quosqhuvor3bCKfH5XOdvX0gErKQC6VQh0R7B9i/fz+dVUpKCnJzcyn97u/3oq7tJjgWEAi9l1yEIhxqVQyN3/rgLgJlMxAdFgmO59DS0QabzQrexUHOBHgHOHToEFwuF5KTk5GXl0drfMeBL3HD2Ayx7PlZ/s6KAnz+3mYKsPVwMeYnarDxzQ8x4hzFp/u2o63rHtyjLohdAu8AFRUVMJlMUKvVKCgooKX3nwLU19fj0qVLNJtzcnKo420p+QK3H7ZPqoCAEUAsFoPnOLyVpce2dz+bUMDqsEETnwRS2n80XMGw9YlvBcxmM86cOYOenh6oVCosX74cX5WVwGTpmwAgeREapIAqNAJKRRhmSOUgxbAoKRmvL86ZABgwDyIhKg4ejoPhdgMsdqtvAOJ0bW1tqKqqgs1mQ0REBCqvnINTylMAUnwyqQzLtBnISdVh0exkiFiWFBtYoRAiVvRyOUD+TSRrampCTU0Ndb2zhguQRQZTAOL5uWlZ0C9dCW38HLg8bjTfb4VtxI6ZyijMVc9+eQAygtPpRHNzM1XjuxPHEBQTSgHErAg71m3GMm06zDYLLlz/HS3GOxhxjSJnkQ7rV659NQDjZkI2psyi1yYAJGIJDm7ZC23CXBhaG3Hw5+PoG3pMVXslZTiZi2UUZmFGtIIqQACObiuBJi4JV5uuo6TiMCw2KzWbZwCOFGNB4jx8svqDqfnAZABEAXG4fGwJRGLs2bALqUkL0dnXhYrfTqK2pZ4GeRpg+9HdmJ84Fxv0618e4I2NhRgN4CgAyfRVGTlYo8tHfKQa3f096Oztgn3UgXhVLJJnaekcdh3fg3kJc/DRqiLYR+zYdGAn7vrjhJMp8P7ODeh1DIyVIcMgKlQFXfJSLNGmIU4VM3EaEglFYFkWjlEHjp4sgzZBg7ezV+OJ1YytR4rRbjL69oHJADZ9sx13eu8/44TEhDTq2Vg4SwulIpwujYfz0OBmuxX3uo1In5NC/aL7cQ92l38LY8+DFwPwdy8Y3/tZIYuP89chNzULQfJA1LfewA9nf8TD/t5nAPy+mEwFICRIAf3SPORlrEBsxEyaH6XnfkJTezPI3kB2Q4lbiCldzYqPfY2G9iaAZcA85zxAFJBLZViQoMEanR6KwGA03WvBiapTMNstcLvc4JweyCFxTelyWtveCOOACVa3HRwzdszy1sjuGCCWIHPBEvokpXqzvXnsaMYDUoEEDIdf6IHO3+v5oG0Ynf0mmIZ64fQ4X/xIxoo4EcvWuD3uvX8B9AE/CfgjW+MAAAAASUVORK5CYII=">
  <link rel="search" type="application/opensearchdescription+xml" href="https://devdocs.io/opensearch.xml" title="Search DevDocs">
  <link rel="stylesheet" type="text/css" href="./Django 5.2 _ Aggregation — DevDocs_files/application-bdc2ebe4f3d1970849c3362e8dbec470e82462afffaacabf3deee9900e667eb4.css">
</head>
<body data-doc="{&quot;name&quot;:&quot;Django&quot;,&quot;slug&quot;:&quot;django~5.2&quot;,&quot;type&quot;:&quot;sphinx&quot;,&quot;links&quot;:{&quot;home&quot;:&quot;https://www.djangoproject.com/&quot;,&quot;code&quot;:&quot;https://github.com/django/django&quot;},&quot;version&quot;:&quot;5.2&quot;,&quot;release&quot;:&quot;5.2&quot;,&quot;mtime&quot;:1740301531,&quot;db_size&quot;:7066403,&quot;attribution&quot;:&quot;&amp;copy; Django Software Foundation and individual contributors&lt;br&gt;\n      Licensed under the BSD License.&quot;,&quot;alias&quot;:null,&quot;full_name&quot;:&quot;Django 5.2&quot;,&quot;slug_without_version&quot;:&quot;django&quot;}">
<noscript class="_fail">DevDocs requires JavaScript to run.</noscript>
<div class="_app" role="application"><div role="alert" class="_notice"><p class="_notice-text"><font _mstmutation="1" _msttexthash="7681765" _msthash="1"> Estás navegando por la documentación de Django 5.2. Para examinar todos los documentos, vaya a <a href="https://devdocs.io/" target="_top" _mstmutation="1" _istranslated="1">devdocs.io</a> (o presione ). </font><code>esc</code></p></div>
  <header class="_header" role="banner">
    <button type="button" aria-label="Toggle navigation" class="_header-btn" data-toggle-sidebar="" hidden="" _msthidden="A" _mstaria-label="320099" _msthash="2">
      <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
    </button>
    <form class="_search" role="search">
      <svg><use xlink:href="#icon-search"></use></svg>
      <input type="search" name="q" class="_search-input" placeholder="Buscar..." autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="30" aria-label="Buscar" _mstplaceholder="1465477" _msthash="3" _mstaria-label="74607">
      <button type="reset" class="_search-clear" title="Clear search" _msthidden="1"><svg><use xlink:href="#icon-close"></use></svg><font _mstmutation="1" _msttexthash="176527" _msthidden="1" _msthash="4">Clear search</font></button>
      <div class="_search-tag"></div>
    </form>
    <button type="button" aria-label="Back" class="_header-btn" data-back="" hidden="" _msthidden="A" _mstaria-label="41587" _msthash="5">
      <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
    </button>
    <button type="button" aria-label="Forward" class="_header-btn _forward-btn" data-forward="" hidden="" _msthidden="A" _mstaria-label="95277" _msthash="6">
      <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"></path></svg>
    </button>
    <button type="button" aria-label="Menú de alternancia" title="Toggle menu" class="_header-btn _menu-btn" data-toggle-menu="" _mstaria-label="158418" _msthash="7">
      <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
    </button>
    <nav class="_menu" role="navigation" _msthidden="7">
      <h1 class="_menu-title" _msthidden="1"><a href="https://devdocs.io/" class="_menu-title-link" _msttexthash="90090" _msthidden="1" _msthash="8">DevDocs</a></h1>
      <a href="https://devdocs.io/settings" class="_menu-link" _msttexthash="179257" _msthidden="1" _msthash="9">Preferences</a>
      <a href="https://devdocs.io/offline" class="_menu-link" _msttexthash="169871" _msthidden="1" _msthash="10">Offline Data</a>
      <a href="https://devdocs.io/news" class="_menu-link" _msttexthash="131586" _msthidden="1" _msthash="11">Changelog</a>
      <a href="https://devdocs.io/help" class="_menu-link" _msttexthash="58357" _msthidden="1" _msthash="12">Guide</a>
      <a href="https://devdocs.io/about" class="_menu-link" _msttexthash="60892" _msthidden="1" _msthash="13">About</a>
      <a href="https://github.com/freeCodeCamp/devdocs/issues/new/choose" class="_menu-link" _msttexthash="158366" _msthidden="1" _msthash="14">Report a bug</a>
    </nav>
  </header>
  <section class="_sidebar" tabindex="-1"><div role="navigation" class="_list"><a href="https://devdocs.io/django~5.2/" class="_list-item _icon-django _list-dir open" data-slug="django~5.2" title="Django 5.2" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="15457" _msthash="15">5.2</span><span class="_list-text" _msttexthash="74906" _msthash="16">Django</span></a><div class="_list _list-sub"><a href="https://devdocs.io/django~5.2-guides/" class="_list-item _list-dir open" data-slug="guides" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="10634" _msthash="17">67</span><span class="_list-text" _msttexthash="75413" _msthash="18">Guías</span></a><div class="_list _list-sub"><a href="https://devdocs.io/django~5.2/topics/testing/advanced" class="_list-item _list-hover" tabindex="-1" _msttexthash="568438" _msthash="253">Temas de pruebas avanzadas</a><a href="https://devdocs.io/django~5.2/topics/db/aggregation" class="_list-item _list-hover focus active" tabindex="-1" _msttexthash="179062" _msthash="254">Agregación</a><a href="https://devdocs.io/django~5.2/topics/async" class="_list-item _list-hover" tabindex="-1" _msttexthash="690417" _msthash="255">Compatibilidad asincrónica</a><a href="https://devdocs.io/django~5.2/topics/class-based-views/generic-display" class="_list-item _list-hover" tabindex="-1" _msttexthash="1475188" _msthash="256">Vistas genéricas integradas basadas en clases</a><a href="https://devdocs.io/django~5.2/topics/class-based-views/index" class="_list-item _list-hover" tabindex="-1" _msttexthash="488150" _msthash="257">Vistas basadas en clases</a><a href="https://devdocs.io/django~5.2/topics/composite-primary-key" class="_list-item _list-hover" tabindex="-1" _msttexthash="666562" _msthash="258">Claves primarias compuestas</a><a href="https://devdocs.io/django~5.2/topics/conditional-view-processing" class="_list-item _list-hover" tabindex="-1" _msttexthash="939666" _msthash="259">Procesamiento de vista condicional</a><a href="https://devdocs.io/django~5.2/topics/forms/modelforms" class="_list-item _list-hover" tabindex="-1" _msttexthash="1309633" _msthash="260">Creación de formularios a partir de modelos</a><a href="https://devdocs.io/django~5.2/topics/signing" class="_list-item _list-hover" tabindex="-1" _msttexthash="411489" _msthash="261">Firma criptográfica</a><a href="https://devdocs.io/django~5.2/topics/auth/customizing" class="_list-item _list-hover" tabindex="-1" _msttexthash="1533311" _msthash="262">Personalización de la autenticación en Django</a><a href="https://devdocs.io/django~5.2/topics/db/optimization" class="_list-item _list-hover" tabindex="-1" _msttexthash="1170507" _msthash="263">Optimización del acceso a la base de datos</a><a href="https://devdocs.io/django~5.2/topics/db/instrumentation" class="_list-item _list-hover" tabindex="-1" _msttexthash="873275" _msthash="264">Instrumentación de bases de datos</a><a href="https://devdocs.io/django~5.2/topics/db/transactions" class="_list-item _list-hover" tabindex="-1" _msttexthash="690729" _msthash="265">Transacciones de base de datos</a><a href="https://devdocs.io/django~5.2/topics/settings" class="_list-item _list-hover" tabindex="-1" _msttexthash="506623" _msthash="266">Configuración de Django</a><a href="https://devdocs.io/django~5.2/topics/http/shortcuts" class="_list-item _list-hover" tabindex="-1" _msttexthash="966368" _msthash="267">Funciones de acceso directo de Django</a><a href="https://devdocs.io/django~5.2/topics/cache" class="_list-item _list-hover" tabindex="-1" _msttexthash="461032" _msthash="268">Marco de caché de Django</a><a href="https://devdocs.io/django~5.2/topics/db/examples/index" class="_list-item _list-hover" tabindex="-1" _msttexthash="1353274" _msthash="269">Ejemplos de uso de la API de relación de modelo</a><a href="https://devdocs.io/django~5.2/topics/external-packages" class="_list-item _list-hover" tabindex="-1" _msttexthash="330213" _msthash="270">Paquetes externos</a><a href="https://devdocs.io/django~5.2/topics/http/file-uploads" class="_list-item _list-hover" tabindex="-1" _msttexthash="286884" _msthash="271">Carga de archivos</a><a href="https://devdocs.io/django~5.2/topics/db/fixtures" class="_list-item _list-hover" tabindex="-1" _msttexthash="158626" _msthash="272">Accesorios</a><a href="https://devdocs.io/django~5.2/topics/forms/media" class="_list-item _list-hover" tabindex="-1" _msttexthash="1022411" _msthash="273">Recursos de formulario (la clase Media)</a><a href="https://devdocs.io/django~5.2/topics/class-based-views/generic-editing" class="_list-item _list-hover" tabindex="-1" _msttexthash="1665586" _msthash="274">Manejo de formularios con vistas basadas en clases</a><a href="https://devdocs.io/django~5.2/topics/i18n/formatting" class="_list-item _list-hover" tabindex="-1" _msttexthash="563537" _msthash="275">Localización de formatos</a><a href="https://devdocs.io/django~5.2/topics/forms/formsets" class="_list-item _list-hover" tabindex="-1" _msttexthash="543595" _msthash="276">Conjuntos de formularios</a><a href="https://devdocs.io/django~5.2/topics/http/generic-views" class="_list-item _list-hover" tabindex="-1" _msttexthash="315627" _msthash="277">Vistas genéricas</a><a href="https://devdocs.io/django~5.2/topics/http/index" class="_list-item _list-hover" tabindex="-1" _msttexthash="535028" _msthash="278">Manejo de solicitudes HTTP</a><a href="https://devdocs.io/django~5.2/topics/install" class="_list-item _list-hover" tabindex="-1" _msttexthash="388492" _msthash="279">Cómo instalar Django</a><a href="https://devdocs.io/django~5.2/topics/http/sessions" class="_list-item _list-hover" tabindex="-1" _msttexthash="440960" _msthash="280">Cómo usar las sesiones</a><a href="https://devdocs.io/django~5.2/topics/i18n/index" class="_list-item _list-hover" tabindex="-1" _msttexthash="1158781" _msthash="281">Internacionalización y localización</a><a href="https://devdocs.io/django~5.2/topics/class-based-views/intro" class="_list-item _list-hover" tabindex="-1" _msttexthash="1302847" _msthash="282">Introducción a las vistas basadas en clases</a><a href="https://devdocs.io/django~5.2/topics/logging" class="_list-item _list-hover" tabindex="-1" _msttexthash="117676" _msthash="283">Registro</a><a href="https://devdocs.io/django~5.2/topics/db/queries" class="_list-item _list-hover" tabindex="-1" _msttexthash="564096" _msthash="284">Realización de consultas</a><a href="https://devdocs.io/django~5.2/topics/db/managers" class="_list-item _list-hover" tabindex="-1" _msttexthash="115258" _msthash="285">Gerentes</a><a href="https://devdocs.io/django~5.2/topics/files" class="_list-item _list-hover" tabindex="-1" _msttexthash="374777" _msthash="286">Gestión de archivos</a><a href="https://devdocs.io/django~5.2/topics/db/examples/many_to_many" class="_list-item _list-hover" tabindex="-1" _msttexthash="662636" _msthash="287">Relaciones de varios a varios</a><a href="https://devdocs.io/django~5.2/topics/db/examples/many_to_one" class="_list-item _list-hover" tabindex="-1" _msttexthash="535145" _msthash="288">Relaciones de muchos a uno</a><a href="https://devdocs.io/django~5.2/topics/http/middleware" class="_list-item _list-hover" tabindex="-1" _msttexthash="479570" _msthash="289">Middleware (Middleware)</a><a href="https://devdocs.io/django~5.2/topics/migrations" class="_list-item _list-hover" tabindex="-1" _msttexthash="179933" _msthash="290">Migraciones</a><a href="https://devdocs.io/django~5.2/topics/db/models" class="_list-item _list-hover" tabindex="-1" _msttexthash="95576" _msthash="291">Modelos</a><a href="https://devdocs.io/django~5.2/topics/db/index" class="_list-item _list-hover" tabindex="-1" _msttexthash="456651" _msthash="292">Modelos y bases de datos</a><a href="https://devdocs.io/django~5.2/topics/db/multi-db" class="_list-item _list-hover" tabindex="-1" _msttexthash="507780" _msthash="293">Múltiples bases de datos</a><a href="https://devdocs.io/django~5.2/topics/db/examples/one_to_one" class="_list-item _list-hover" tabindex="-1" _msttexthash="356967" _msthash="294">Relaciones uno a uno</a><a href="https://devdocs.io/django~5.2/topics/pagination" class="_list-item _list-hover" tabindex="-1" _msttexthash="180037" _msthash="295">Paginación</a><a href="https://devdocs.io/django~5.2/topics/auth/passwords" class="_list-item _list-hover" tabindex="-1" _msttexthash="839787" _msthash="296">Gestión de contraseñas en Django</a><a href="https://devdocs.io/django~5.2/topics/performance" class="_list-item _list-hover" tabindex="-1" _msttexthash="673907" _msthash="297">Rendimiento y optimización</a><a href="https://devdocs.io/django~5.2/topics/db/sql" class="_list-item _list-hover" tabindex="-1" _msttexthash="1230671" _msthash="298">Realización de consultas SQL sin procesar</a><a href="https://devdocs.io/django~5.2/topics/db/search" class="_list-item _list-hover" tabindex="-1" _msttexthash="76154" _msthash="299">Buscar</a><a href="https://devdocs.io/django~5.2/topics/security" class="_list-item _list-hover" tabindex="-1" _msttexthash="337363" _msthash="300">Seguridad en Django</a><a href="https://devdocs.io/django~5.2/topics/email" class="_list-item _list-hover" tabindex="-1" _msttexthash="201799" _msthash="301">Sending email</a><a href="https://devdocs.io/django~5.2/topics/serialization" class="_list-item _list-hover" tabindex="-1" _msttexthash="604201" _msthash="302">Serializing Django objects</a><span role="link" class="_list-item _list-pagelink" _msttexthash="1764373" _msthash="303">Show more… (17)</span></div><a href="https://devdocs.io/django~5.2-guides-how-tos/" class="_list-item _list-dir" data-slug="guides-how-tos" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="10049" _msthash="70">34</span><span class="_list-text" _msttexthash="327925" _msthash="71">Guías: Tutoriales</span></a><a href="https://devdocs.io/django~5.2-guides-intro/" class="_list-item _list-dir" data-slug="guides-intro" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="9763" _msthash="72">13</span><span class="_list-text" _msttexthash="429754" _msthash="73">Guías: Introducción</span></a><a href="https://devdocs.io/django~5.2-api/" class="_list-item _list-dir" data-slug="api" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="15990" _msthash="74">117</span><span class="_list-text" _msttexthash="22776" _msthash="75">API</span></a><a href="https://devdocs.io/django~5.2-django-apps/" class="_list-item _list-dir" data-slug="django-apps" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="10283" _msthash="76">18</span><span class="_list-text" _msttexthash="173797" _msthash="77">django.apps</span></a><a href="https://devdocs.io/django~5.2-django-conf/" class="_list-item _list-dir" data-slug="django-conf" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="5096" _msthash="78">8</span><span class="_list-text" _msttexthash="170677" _msthash="79">django.conf</span></a><a href="https://devdocs.io/django~5.2-django-contrib-admin/" class="_list-item _list-dir" data-slug="django-contrib-admin" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="16627" _msthash="80">168</span><span class="_list-text" _msttexthash="427375" _msthash="81">django.contrib.admin</span></a><a href="https://devdocs.io/django~5.2-django-contrib-auth/" class="_list-item _list-dir" data-slug="django-contrib-auth" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="15795" _msthash="82">251</span><span class="_list-text" _msttexthash="397137" _msthash="83">django.contrib.auth</span></a><a href="https://devdocs.io/django~5.2-django-contrib-contenttypes/" class="_list-item _list-dir" data-slug="django-contrib-contenttypes" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="9958" _msthash="84">24</span><span class="_list-text" _msttexthash="740324" _msthash="85">django.contrib.contenttypes</span></a><a href="https://devdocs.io/django~5.2-django-contrib-flatpages/" class="_list-item _list-dir" data-slug="django-contrib-flatpages" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="4641" _msthash="86">3</span><span class="_list-text" _msttexthash="586170" _msthash="87">django.contrib.flatpages</span></a><a href="https://devdocs.io/django~5.2-django-contrib-gis/" class="_list-item _list-dir" data-slug="django-contrib-gis" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="15691" _msthash="88">403</span><span class="_list-text" _msttexthash="361153" _msthash="89">django.contrib.gis</span></a><a href="https://devdocs.io/django~5.2-django-contrib-messages/" class="_list-item _list-dir" data-slug="django-contrib-messages" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="9555" _msthash="90">11</span><span class="_list-text" _msttexthash="547599" _msthash="91">django.contrib.mensajes</span></a><a href="https://devdocs.io/django~5.2-django-contrib-postgres/" class="_list-item _list-dir" data-slug="django-contrib-postgres" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="15756" _msthash="92">115</span><span class="_list-text" _msttexthash="558168" _msthash="93">django.contrib.postgres</span></a><a href="https://devdocs.io/django~5.2-django-contrib-redirects/" class="_list-item _list-dir" data-slug="django-contrib-redirects" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="4732" _msthash="94">4</span><span class="_list-text" _msttexthash="765492" _msthash="95">django.contrib.redirecciones</span></a><a href="https://devdocs.io/django~5.2-django-contrib-sessions/" class="_list-item _list-dir" data-slug="django-contrib-sessions" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="9906" _msthash="96">60</span><span class="_list-text" _msttexthash="558610" _msthash="97">django.contrib.sessions</span></a><a href="https://devdocs.io/django~5.2-django-contrib-sitemaps/" class="_list-item _list-dir" data-slug="django-contrib-sitemaps" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="10283" _msthash="98">18</span><span class="_list-text" _msttexthash="552734" _msthash="99">django.contrib.sitemaps</span></a><a href="https://devdocs.io/django~5.2-django-contrib-sites/" class="_list-item _list-dir" data-slug="django-contrib-sites" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="5096" _msthash="100">8</span><span class="_list-text" _msttexthash="436592" _msthash="101">django.contrib.sites</span></a><a href="https://devdocs.io/django~5.2-django-contrib-staticfiles/" class="_list-item _list-dir" data-slug="django-contrib-staticfiles" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="9555" _msthash="102">11</span><span class="_list-text" _msttexthash="677573" _msthash="103">django.contrib.staticfiles</span></a><a href="https://devdocs.io/django~5.2-django-contrib-syndication/" class="_list-item _list-dir" data-slug="django-contrib-syndication" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="4550" _msthash="104">2</span><span class="_list-text" _msttexthash="681031" _msthash="105">django.contrib.syndication</span></a><a href="https://devdocs.io/django~5.2-django-core/" class="_list-item _list-dir" data-slug="django-core" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="15743" _msthash="106">205</span><span class="_list-text" _msttexthash="171288" _msthash="107">django.core</span></a><a href="https://devdocs.io/django~5.2-django-db-backends/" class="_list-item _list-dir" data-slug="django-db-backends" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="9542" _msthash="108">20</span><span class="_list-text" _msttexthash="353912" _msthash="109">django.db.backends</span></a><a href="https://devdocs.io/django~5.2-django-db-connection/" class="_list-item _list-dir" data-slug="django-db-connection" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="4641" _msthash="110">3</span><span class="_list-text" _msttexthash="403520" _msthash="111">django.db.conexión</span></a><a href="https://devdocs.io/django~5.2-django-db-migrations/" class="_list-item _list-dir" data-slug="django-db-migrations" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="10049" _msthash="112">34</span><span class="_list-text" _msttexthash="467285" _msthash="113">django.db.migraciones</span></a><a href="https://devdocs.io/django~5.2-django-db-models/" class="_list-item _list-dir" data-slug="django-db-models" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="16393" _msthash="114">491</span><span class="_list-text" _msttexthash="329108" _msthash="115">django.db.modelos</span></a><a href="https://devdocs.io/django~5.2-django-db-transaction/" class="_list-item _list-dir" data-slug="django-db-transaction" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="9763" _msthash="116">13</span><span class="_list-text" _msttexthash="511836" _msthash="117">django.db.transacción</span></a><a href="https://devdocs.io/django~5.2-django-dispatch/" class="_list-item _list-dir" data-slug="django-dispatch" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="5096" _msthash="118">8</span><span class="_list-text" _msttexthash="278421" _msthash="119">django.dispatch</span></a><a href="https://devdocs.io/django~5.2-django-forms/" class="_list-item _list-dir" data-slug="django-forms" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="16705" _msthash="120">277</span><span class="_list-text" _msttexthash="383097" _msthash="121">django.formularios</span></a><a href="https://devdocs.io/django~5.2-django-http/" class="_list-item _list-dir" data-slug="django-http" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="16120" _msthash="122">109</span><span class="_list-text" _msttexthash="176020" _msthash="123">django.http</span></a><a href="https://devdocs.io/django~5.2-django-middleware/" class="_list-item _list-dir" data-slug="django-middleware" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="9763" _msthash="124">13</span><span class="_list-text" _msttexthash="339248" _msthash="125">django.middleware</span></a><a href="https://devdocs.io/django~5.2-django-setup/" class="_list-item _list-dir" data-slug="django-setup" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="4459" _msthash="126">1</span><span class="_list-text" _msttexthash="202410" _msthash="127">django.setup</span></a><a href="https://devdocs.io/django~5.2-django-shortcuts/" class="_list-item _list-dir" data-slug="django-shortcuts" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="4914" _msthash="128">6</span><span class="_list-text" _msttexthash="223847" _msthash="129">django.atajos</span></a><a href="https://devdocs.io/django~5.2-django-template/" class="_list-item _list-dir" data-slug="django-template" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="10335" _msthash="130">55</span><span class="_list-text" _msttexthash="309907" _msthash="131">django.plantilla</span></a><a href="https://devdocs.io/django~5.2-django-test/" class="_list-item _list-dir" data-slug="django-test" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="10803" _msthash="132">96</span><span class="_list-text" _msttexthash="175955" _msthash="133">django.test</span></a><a href="https://devdocs.io/django~5.2-django-urls/" class="_list-item _list-dir" data-slug="django-urls" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="9750" _msthash="134">22</span><span class="_list-text" _msttexthash="176995" _msthash="135">django.urls</span></a><a href="https://devdocs.io/django~5.2-django-utils/" class="_list-item _list-dir" data-slug="django-utils" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="15522" _msthash="136">113</span><span class="_list-text" _msttexthash="202124" _msthash="137">django.utils</span></a><a href="https://devdocs.io/django~5.2-django-views/" class="_list-item _list-dir" data-slug="django-views" tabindex="-1"><svg class="_list-arrow"><use xlink:href="#icon-dir"></use></svg><span class="_list-count" _msttexthash="16081" _msthash="138">217</span><span class="_list-text" _msttexthash="201760" _msthash="139">django.views</span></a></div></div></section>
  <div class="_container" role="document">
    <main class="_content" role="main"><div class="_page _sphinx"><section id="s-aggregation"> <h1 id="aggregation" _msttexthash="179062" _msthash="338">Agregación</h1> <p _msttexthash="105331863" _msthash="339">La guía <a class="reference internal" href="https://devdocs.io/django~5.2/topics/db/queries" _istranslated="1"><span class="doc" _istranslated="1">temática de la API de abstracción de base de datos de Django</span></a> describe la forma en que puede utilizar las consultas de Django que crean, recuperan, actualizan y eliminan objetos individuales. Sin embargo, a veces será necesario recuperar valores que se derivan mediante la suma o <em _istranslated="1">agregación</em> de una colección de objetos. En esta guía temática se describen las formas en que se pueden generar y devolver valores agregados mediante consultas de Django.</p> <p _msttexthash="16096288" _msthash="340">A lo largo de esta guía, nos referiremos a los siguientes modelos. Estos modelos se utilizan para realizar un seguimiento del inventario de una serie de librerías en línea:</p> <pre data-language="python" class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models


<span class="token keyword">class</span> <span class="token class-name">Author</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
    age <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Publisher</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Book</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span>
    pages <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span><span class="token punctuation">)</span>
    price <span class="token operator">=</span> models<span class="token punctuation">.</span>DecimalField<span class="token punctuation">(</span>max_digits<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> decimal_places<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    rating <span class="token operator">=</span> models<span class="token punctuation">.</span>FloatField<span class="token punctuation">(</span><span class="token punctuation">)</span>
    authors <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span>Author<span class="token punctuation">)</span>
    publisher <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>Publisher<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span>
    pubdate <span class="token operator">=</span> models<span class="token punctuation">.</span>DateField<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span>
    books <span class="token operator">=</span> models<span class="token punctuation">.</span>ManyToManyField<span class="token punctuation">(</span>Book<span class="token punctuation">)</span>
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="304"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <section id="s-cheat-sheet"> <h2 id="cheat-sheet" _msttexthash="93574" _msthash="341">Chuleta</h2> <p _msttexthash="8799661" _msthash="342">¿Tienes prisa? A continuación, se muestra cómo realizar consultas de agregado comunes, suponiendo los modelos anteriores:</p> <pre data-language="pycon" class="language-pycon"># Total number of books.
&gt;&gt;&gt; Book.objects.count()
2452

# Total number of books with publisher=BaloneyPress
&gt;&gt;&gt; Book.objects.filter(publisher__name="BaloneyPress").count()
73

# Average price across all books, provide default to be returned instead
# of None if no books exist.
&gt;&gt;&gt; from django.db.models import Avg
&gt;&gt;&gt; Book.objects.aggregate(Avg("price", default=0))
{'price__avg': 34.35}

# Max price across all books, provide default to be returned instead of
# None if no books exist.
&gt;&gt;&gt; from django.db.models import Max
&gt;&gt;&gt; Book.objects.aggregate(Max("price", default=0))
{'price__max': Decimal('81.20')}

# Difference between the highest priced book and the average price of all books.
&gt;&gt;&gt; from django.db.models import FloatField
&gt;&gt;&gt; Book.objects.aggregate(
...     price_diff=Max("price", output_field=FloatField()) - Avg("price")
... )
{'price_diff': 46.85}

# All the following queries involve traversing the Book&lt;-&gt;Publisher
# foreign key relationship backwards.

# Each publisher, each with a count of books as a "num_books" attribute.
&gt;&gt;&gt; from django.db.models import Count
&gt;&gt;&gt; pubs = Publisher.objects.annotate(num_books=Count("book"))
&gt;&gt;&gt; pubs
&lt;QuerySet [&lt;Publisher: BaloneyPress&gt;, &lt;Publisher: SalamiPress&gt;, ...]&gt;
&gt;&gt;&gt; pubs[0].num_books
73

# Each publisher, with a separate count of books with a rating above and below 5
&gt;&gt;&gt; from django.db.models import Q
&gt;&gt;&gt; above_5 = Count("book", filter=Q(book__rating__gt=5))
&gt;&gt;&gt; below_5 = Count("book", filter=Q(book__rating__lte=5))
&gt;&gt;&gt; pubs = Publisher.objects.annotate(below_5=below_5).annotate(above_5=above_5)
&gt;&gt;&gt; pubs[0].above_5
23
&gt;&gt;&gt; pubs[0].below_5
12

# The top 5 publishers, in order by number of books.
&gt;&gt;&gt; pubs = Publisher.objects.annotate(num_books=Count("book")).order_by("-num_books")[:5]
&gt;&gt;&gt; pubs[0].num_books
1323
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="305"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> </section> <section id="s-generating-aggregates-over-a-queryset"> <h2 id="generating-aggregates-over-a-queryset"><font _mstmutation="1" _msttexthash="1188915" _msthash="343">La generación de agregados a través de un </font><code>QuerySet</code>
</h2> <p><font _mstmutation="1" _msttexthash="54121093" _msthash="344">Django proporciona dos formas de generar agregados. La primera forma es generar valores de resumen en un archivo . Por ejemplo, supongamos que desea calcular el precio promedio de todos los libros disponibles para la venta. La sintaxis de consulta de Django proporciona un medio para describir el conjunto de todos los libros:</font><code>QuerySet</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Book.objects.all()
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="306"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="11789141" _msthash="345">Lo que necesitamos es una forma de calcular los valores de resumen sobre los objetos que pertenecen a este . Esto se hace agregando una cláusula en el :</font><code>QuerySet</code><code>aggregate()</code><code>QuerySet</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; from django.db.models import Avg
&gt;&gt;&gt; Book.objects.all().aggregate(Avg("price"))
{'price__avg': 34.35}
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="307"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="2785705" _msthash="346">El es redundante en este ejemplo, por lo que podría simplificarse a:</font><code>all()</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Book.objects.aggregate(Avg("price"))
{'price__avg': 34.35}
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="308"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="28109315" _msthash="347">El argumento de la cláusula describe el valor agregado que queremos calcular, en este caso, el promedio del campo en el modelo. Puede encontrar una lista de las funciones de agregado que están disponibles en la referencia de <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#aggregation-functions" _mstmutation="1" _istranslated="1"><span class="std std-ref" _istranslated="1">QuerySet</span></a>.</font><code>aggregate()</code><code>price</code><code>Book</code></p> <p><code>aggregate()</code><font _mstmutation="1" _msttexthash="96060341" _msthash="348"> es una cláusula terminal para a que, cuando se invoca, devuelve un diccionario de pares nombre-valor. El nombre es un identificador para el valor agregado; El valor es el agregado calculado. El nombre se genera automáticamente a partir del nombre del campo y de la función de agregado. Si desea especificar manualmente un nombre para el valor agregado, puede hacerlo proporcionando ese nombre cuando especifique la cláusula aggregate:</font><code>QuerySet</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Book.objects.aggregate(average_price=Avg("price"))
{'average_price': 34.35}
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="309"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="18907512" _msthash="349">Si desea generar más de un agregado, agregue otro argumento a la cláusula. Entonces, si además quisiéramos saber el precio máximo y mínimo de todos los libros, emitiríamos la consulta:</font><code>aggregate()</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; from django.db.models import Avg, Max, Min
&gt;&gt;&gt; Book.objects.aggregate(Avg("price"), Max("price"), Min("price"))
{'price__avg': 34.35, 'price__max': Decimal('81.20'), 'price__min': Decimal('12.99')}
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="310"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> </section> <section id="s-generating-aggregates-for-each-item-in-a-queryset"> <h2 id="generating-aggregates-for-each-item-in-a-queryset"><font _mstmutation="1" _msttexthash="1669733" _msthash="350">La generación de agregados para cada elemento de un </font><code>QuerySet</code>
</h2> <p><font _mstmutation="1" _msttexthash="69115176" _msthash="351">La segunda manera de generar valores de resumen es generar un resumen independiente para cada objeto <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet" _mstmutation="1" _istranslated="1"><code _istranslated="1">de un QuerySet</code></a>. Por ejemplo, si está recuperando una lista de libros, es posible que desee saber cuántos autores contribuyeron a cada libro. Cada Libro tiene una relación de muchos a muchos con el Autor; Queremos resumir esta relación para cada libro de la colección .</font><code>QuerySet</code></p> <p><font _mstmutation="1" _msttexthash="16306004" _msthash="352">Los resúmenes por objeto se pueden generar utilizando la cláusula <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate" _mstmutation="1" _istranslated="1"><code _istranslated="1">annotate().</code></a> Cuando se especifica una cláusula, cada objeto de la se anotará con los valores especificados.</font><code>annotate()</code><code>QuerySet</code></p> <p><font _mstmutation="1" _msttexthash="21892715" _msthash="353">La sintaxis de estas anotaciones es idéntica a la utilizada para la cláusula <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#django.db.models.query.QuerySet.aggregate" title="django.db.models.query.QuerySet.aggregate" _mstmutation="1" _istranslated="1"><code _istranslated="1">aggregate().</code></a> Cada argumento describe un agregado que se va a calcular. Por ejemplo, para anotar libros con el número de autores:</font><code>annotate()</code></p> <pre data-language="pycon" class="language-pycon"># Build an annotated queryset
&gt;&gt;&gt; from django.db.models import Count
&gt;&gt;&gt; q = Book.objects.annotate(Count("authors"))
# Interrogate the first object in the queryset
&gt;&gt;&gt; q[0]
&lt;Book: The Definitive Guide to Django&gt;
&gt;&gt;&gt; q[0].authors__count
2
# Interrogate the second object in the queryset
&gt;&gt;&gt; q[1]
&lt;Book: Practical Django Projects&gt;
&gt;&gt;&gt; q[1].authors__count
1
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="311"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="32559423" _msthash="354">Al igual que con , el nombre de la anotación se deriva automáticamente del nombre de la función de agregado y del nombre del campo que se está agregando. Puede invalidar este nombre predeterminado proporcionando un alias al especificar la anotación:</font><code>aggregate()</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; q = Book.objects.annotate(num_authors=Count("authors"))
&gt;&gt;&gt; q[0].num_authors
2
&gt;&gt;&gt; q[1].num_authors
1
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="312"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="18264194" _msthash="355">A diferencia de , <em _mstmutation="1" _istranslated="1">no</em> es una cláusula terminal. La salida de la cláusula es un ; Esto se puede modificar utilizando cualquier otra operación, incluyendo , , o incluso llamadas adicionales a .</font><code>aggregate()</code><code>annotate()</code><code>annotate()</code><code>QuerySet</code><code>QuerySet</code><code>QuerySet</code><code>filter()</code><code>order_by()</code><code>annotate()</code></p> <section id="s-combining-multiple-aggregations"> <h3 id="id1" _msttexthash="957892" _msthash="356">Combinación de varias agregaciones</h3> <p><font _mstmutation="1" _msttexthash="10694047" _msthash="357">La combinación de varias agregaciones con <a class="extlink-ticket reference external" href="https://code.djangoproject.com/ticket/10060" _mstmutation="1" _istranslated="1">producirá resultados incorrectos</a> porque se utilizan combinaciones en lugar de subconsultas:</font><code>annotate()</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; book = Book.objects.first()
&gt;&gt;&gt; book.authors.count()
2
&gt;&gt;&gt; book.store_set.count()
3
&gt;&gt;&gt; q = Book.objects.annotate(Count("authors"), Count("store"))
&gt;&gt;&gt; q[0].authors__count
6
&gt;&gt;&gt; q[0].store__count
6
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="313"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="10354357" _msthash="358">Para la mayoría de los agregados, no hay forma de evitar este problema, sin embargo, el agregado <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#django.db.models.Count" title="django.db.models.Count" _mstmutation="1" _istranslated="1"><code _istranslated="1">Count</code></a> tiene un parámetro que puede ayudar:</font><code>distinct</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; q = Book.objects.annotate(
...     Count("authors", distinct=True), Count("store", distinct=True)
... )
&gt;&gt;&gt; q[0].authors__count
2
&gt;&gt;&gt; q[0].store__count
3
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="314"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <div class="admonition-if-in-doubt-inspect-the-sql-query admonition"> <p class="admonition-title" _msttexthash="1244854" _msthash="359">En caso de duda, inspeccione la consulta SQL.</p> <p><font _mstmutation="1" _msttexthash="5287776" _msthash="360">Para comprender lo que sucede en la consulta, considere inspeccionar la propiedad de su archivo .</font><code>query</code><code>QuerySet</code></p> </div> </section> </section> <section id="s-joins-and-aggregates"> <h2 id="joins-and-aggregates" _msttexthash="352092" _msthash="361">Uniones y agregados</h2> <p _msttexthash="27902199" _msthash="362">Hasta ahora, nos hemos ocupado de los agregados de los campos que pertenecen al modelo que se está consultando. Sin embargo, a veces el valor que desea agregar pertenecerá a un modelo relacionado con el modelo que está consultando.</p> <p _msttexthash="55169855" _msthash="363">Al especificar el campo que se agregará en una función de agregado, Django le permitirá usar la misma <a class="reference internal" href="https://devdocs.io/django~5.2/topics/db/queries#field-lookups-intro" _istranslated="1"><span class="std std-ref" _istranslated="1">notación de doble guión bajo</span></a> que se usa cuando se hace referencia a campos relacionados en filtros. A continuación, Django se encargará de las uniones de tablas que sean necesarias para recuperar y agregar el valor relacionado.</p> <p _msttexthash="7393789" _msthash="364">Por ejemplo, para encontrar el rango de precios de los libros que se ofrecen en cada tienda, puede usar la anotación:</p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; from django.db.models import Max, Min
&gt;&gt;&gt; Store.objects.annotate(min_price=Min("books__price"), max_price=Max("books__price"))
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="315"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="20439016" _msthash="365">Esto le dice a Django que recupere el modelo, se una (a través de la relación de varios a varios) con el modelo y agregue en el campo de precio del modelo de libro para producir un valor mínimo y máximo.</font><code>Store</code><code>Book</code></p> <p><font _mstmutation="1" _msttexthash="19300021" _msthash="366">Las mismas reglas se aplican a la cláusula. Si desea saber el precio más bajo y más alto de cualquier libro que esté disponible para la venta en cualquiera de las tiendas, puede usar el agregado:</font><code>aggregate()</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Store.objects.aggregate(min_price=Min("books__price"), max_price=Max("books__price"))
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="316"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p _msttexthash="18436613" _msthash="367">Las cadenas de unión pueden ser tan profundas como necesite. Por ejemplo, para extraer la edad del autor más joven de cualquier libro disponible para la venta, podría emitir la consulta:</p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Store.objects.aggregate(youngest_age=Min("books__authors__age"))
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="317"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <section id="s-following-relationships-backwards"> <h3 id="following-relationships-backwards" _msttexthash="1101750" _msthash="368">Seguimiento de relaciones hacia atrás</h3> <p _msttexthash="57106660" _msthash="369">De manera similar a <a class="reference internal" href="https://devdocs.io/django~5.2/topics/db/queries#lookups-that-span-relationships" _istranslated="1"><span class="std std-ref" _istranslated="1">las búsquedas que abarcan relaciones</span></a>, las agregaciones y anotaciones en campos de modelos o modelos que están relacionados con el que está consultando pueden incluir el recorrido de relaciones "inversas". Aquí también se utiliza el nombre en minúsculas de los modelos relacionados y los guiones bajos dobles.</p> <p><font _mstmutation="1" _msttexthash="20552675" _msthash="370">Por ejemplo, podemos pedir todos los editores, anotados con sus respectivos contadores de existencias totales de libros (observe cómo usamos especificar el salto de clave extranjera inversa -&gt;):</font><code>'book'</code><code>Publisher</code><code>Book</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; from django.db.models import Avg, Count, Min, Sum
&gt;&gt;&gt; Publisher.objects.annotate(Count("book"))
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="318"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="2799394" _msthash="371">(Cada uno de los resultantes tendrá un atributo adicional llamado .)</font><code>Publisher</code><code>QuerySet</code><code>book__count</code></p> <p _msttexthash="5043792" _msthash="372">También podemos pedir el libro más antiguo de cualquiera de los que gestionan cada editorial:</p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Publisher.objects.aggregate(oldest_pubdate=Min("book__pubdate"))
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="319"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="9051107" _msthash="373">(El diccionario resultante tendrá una clave llamada . Si no se especificara ningún alias de este tipo, sería el bastante largo .)</font><code>'oldest_pubdate'</code><code>'book__pubdate__min'</code></p> <p><font _mstmutation="1" _msttexthash="50544052" _msthash="374">Esto no se aplica solo a las claves externas. También funciona con relaciones de varios a varios. Por ejemplo, podemos preguntar por cada autor, anotado con el número total de páginas considerando todos los libros que el autor ha (co)escrito (observe cómo usamos especificar el salto -&gt; inverso de varios a varios):</font><code>'book'</code><code>Author</code><code>Book</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Author.objects.annotate(total_pages=Sum("book__pages"))
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="320"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="10894208" _msthash="375">(Cada uno de los resultantes tendrá un atributo adicional llamado . Si no se especificara ningún alias de este tipo, sería el bastante largo .)</font><code>Author</code><code>QuerySet</code><code>total_pages</code><code>book__pages__sum</code></p> <p _msttexthash="7689825" _msthash="376">O pida la calificación promedio de todos los libros escritos por el autor o autores que tenemos en nuestros archivos:</p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Author.objects.aggregate(average_rating=Avg("book__rating"))
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="321"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="6555627" _msthash="377">(The resulting dictionary will have a key called . If no such alias were specified, it would be the rather long .)</font><code>'average_rating'</code><code>'book__rating__avg'</code></p> </section> </section> <section id="s-aggregations-and-other-queryset-clauses"> <h2 id="aggregations-and-other-queryset-clauses"><font _mstmutation="1" _msttexthash="750347" _msthash="378">Aggregations and other  clauses</font><code>QuerySet</code></h2> <section id="s-filter-and-exclude"> <h3 id="filter-and-exclude">
<code>filter()</code><font _mstmutation="1" _msttexthash="31967" _msthash="379"> and </font><code>exclude()</code>
</h3> <p><font _mstmutation="1" _msttexthash="15402322" _msthash="380">Aggregates can also participate in filters. Any  (or ) applied to normal model fields will have the effect of constraining the objects that are considered for aggregation.</font><code>filter()</code><code>exclude()</code></p> <p><font _mstmutation="1" _msttexthash="66612364" _msthash="381">When used with an  clause, a filter has the effect of constraining the objects for which an annotation is calculated. For example, you can generate an annotated list of all books that have a title starting with “Django” using the query:</font><code>annotate()</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; from django.db.models import Avg, Count
&gt;&gt;&gt; Book.objects.filter(name__startswith="Django").annotate(num_authors=Count("authors"))
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="322"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="66115426" _msthash="382">When used with an  clause, a filter has the effect of constraining the objects over which the aggregate is calculated. For example, you can generate the average price of all books with a title that starts with “Django” using the query:</font><code>aggregate()</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Book.objects.filter(name__startswith="Django").aggregate(Avg("price"))
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="323"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <section id="s-filtering-on-annotations"> <h4 id="id2" _msttexthash="541736" _msthash="383">Filtering on annotations</h4> <p><font _mstmutation="1" _msttexthash="9393761" _msthash="384">Annotated values can also be filtered. The alias for the annotation can be used in  and  clauses in the same way as any other model field.</font><code>filter()</code><code>exclude()</code></p> <p _msttexthash="5013866" _msthash="385">For example, to generate a list of books that have more than one author, you can issue the query:</p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Book.objects.annotate(num_authors=Count("authors")).filter(num_authors__gt=1)
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="324"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p _msttexthash="5837143" _msthash="386">This query generates an annotated result set, and then generates a filter based upon that annotation.</p> <p><font _mstmutation="1" _msttexthash="16012243" _msthash="387">If you need two annotations with two separate filters you can use the  argument with any aggregate. For example, to generate a list of authors with a count of highly rated books:</font><code>filter</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; highly_rated = Count("book", filter=Q(book__rating__gte=7))
&gt;&gt;&gt; Author.objects.annotate(num_books=Count("book"), highly_rated_books=highly_rated)
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="325"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="4214392" _msthash="388">Each  in the result set will have the  and  attributes. See also <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/conditional-expressions#conditional-aggregation" _mstmutation="1"><span class="std std-ref">Conditional aggregation</span></a>.</font><code>Author</code><code>num_books</code><code>highly_rated_books</code></p> <div class="admonition-choosing-between-filter-and-queryset-filter admonition"> <p class="admonition-title"><font _mstmutation="1" _msttexthash="381160" _msthash="389">Choosing between  and </font><code>filter</code><code>QuerySet.filter()</code></p> <p><font _mstmutation="1" _msttexthash="37024182" _msthash="390">Avoid using the  argument with a single annotation or aggregation. It’s more efficient to use  to exclude rows. The aggregation  argument is only useful when using two or more aggregations over the same relations with different conditionals.</font><code>filter</code><code>QuerySet.filter()</code><code>filter</code></p> </div> </section> <section id="s-order-of-annotate-and-filter-clauses"> <h4 id="order-of-annotate-and-filter-clauses"><font _mstmutation="1" _msttexthash="350831" _msthash="391">Order of  and  clauses</font><code>annotate()</code><code>filter()</code></h4> <p><font _mstmutation="1" _msttexthash="10842208" _msthash="392">When developing a complex query that involves both  and  clauses, pay particular attention to the order in which the clauses are applied to the .</font><code>annotate()</code><code>filter()</code><code>QuerySet</code></p> <p><font _mstmutation="1" _msttexthash="24904776" _msthash="393">When an  clause is applied to a query, the annotation is computed over the state of the query up to the point where the annotation is requested. The practical implication of this is that  and  are not commutative operations.</font><code>annotate()</code><code>filter()</code><code>annotate()</code></p> <p _msttexthash="69095" _msthash="394">Given:</p> <ul class="simple"> <li _msttexthash="1256580" _msthash="395">Publisher A has two books with ratings 4 and 5.</li> <li _msttexthash="1254708" _msthash="396">Publisher B has two books with ratings 1 and 4.</li> <li _msttexthash="939367" _msthash="397">Publisher C has one book with rating 1.</li> </ul> <p><font _mstmutation="1" _msttexthash="2125903" _msthash="398">Here’s an example with the  aggregate:</font><code>Count</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; a, b = Publisher.objects.annotate(num_books=Count("book", distinct=True)).filter(
...     book__rating__gt=3.0
... )
&gt;&gt;&gt; a, a.num_books
(&lt;Publisher: A&gt;, 2)
&gt;&gt;&gt; b, b.num_books
(&lt;Publisher: B&gt;, 2)

&gt;&gt;&gt; a, b = Publisher.objects.filter(book__rating__gt=3.0).annotate(num_books=Count("book"))
&gt;&gt;&gt; a, a.num_books
(&lt;Publisher: A&gt;, 2)
&gt;&gt;&gt; b, b.num_books
(&lt;Publisher: B&gt;, 1)
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="326"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p _msttexthash="8354892" _msthash="399">Both queries return a list of publishers that have at least one book with a rating exceeding 3.0, hence publisher C is excluded.</p> <p><font _mstmutation="1" _msttexthash="9592375" _msthash="400">In the first query, the annotation precedes the filter, so the filter has no effect on the annotation.  is required to avoid a <a class="reference internal" href="https://devdocs.io/django~5.2/topics/db/aggregation#combining-multiple-aggregations" _mstmutation="1"><span class="std std-ref">query bug</span></a>.</font><code>distinct=True</code></p> <p _msttexthash="23942854" _msthash="401">The second query counts the number of books that have a rating exceeding 3.0 for each publisher. The filter precedes the annotation, so the filter constrains the objects considered when calculating the annotation.</p> <p><font _mstmutation="1" _msttexthash="2409342" _msthash="402">Here’s another example with the  aggregate:</font><code>Avg</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; a, b = Publisher.objects.annotate(avg_rating=Avg("book__rating")).filter(
...     book__rating__gt=3.0
... )
&gt;&gt;&gt; a, a.avg_rating
(&lt;Publisher: A&gt;, 4.5)  # (5+4)/2
&gt;&gt;&gt; b, b.avg_rating
(&lt;Publisher: B&gt;, 2.5)  # (1+4)/2

&gt;&gt;&gt; a, b = Publisher.objects.filter(book__rating__gt=3.0).annotate(
...     avg_rating=Avg("book__rating")
... )
&gt;&gt;&gt; a, a.avg_rating
(&lt;Publisher: A&gt;, 4.5)  # (5+4)/2
&gt;&gt;&gt; b, b.avg_rating
(&lt;Publisher: B&gt;, 4.0)  # 4/1 (book with rating 1 excluded)
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="327"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p _msttexthash="81342677" _msthash="403">The first query asks for the average rating of all a publisher’s books for publisher’s that have at least one book with a rating exceeding 3.0. The second query asks for the average of a publisher’s book’s ratings for only those ratings exceeding 3.0.</p> <p><font _mstmutation="1" _msttexthash="12987949" _msthash="404">It’s difficult to intuit how the ORM will translate complex querysets into SQL queries so when in doubt, inspect the SQL with  and write plenty of tests.</font><code>str(queryset.query)</code></p> </section> </section> <section id="s-order-by"> <h3 id="order-by"><code>order_by()</code></h3> <p><font _mstmutation="1" _msttexthash="14436045" _msthash="405">Annotations can be used as a basis for ordering. When you define an  clause, the aggregates you provide can reference any alias defined as part of an  clause in the query.</font><code>order_by()</code><code>annotate()</code></p> <p><font _mstmutation="1" _msttexthash="8457761" _msthash="406">For example, to order a  of books by the number of authors that have contributed to the book, you could use the following query:</font><code>QuerySet</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Book.objects.annotate(num_authors=Count("authors")).order_by("num_authors")
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="328"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> </section> <section id="s-values"> <h3 id="values"><code>values()</code></h3> <p><font _mstmutation="1" _msttexthash="167598678" _msthash="407">Ordinarily, annotations are generated on a per-object basis - an annotated  will return one result for each object in the original . However, when a  clause is used to constrain the columns that are returned in the result set, the method for evaluating annotations is slightly different. Instead of returning an annotated result for each result in the original , the original results are grouped according to the unique combinations of the fields specified in the  clause. An annotation is then provided for each unique group; the annotation is computed over all members of the group.</font><code>QuerySet</code><code>QuerySet</code><code>values()</code><code>QuerySet</code><code>values()</code></p> <p _msttexthash="7277023" _msthash="408">For example, consider an author query that attempts to find out the average rating of books written by each author:</p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Author.objects.annotate(average_rating=Avg("book__rating"))
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="329"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p _msttexthash="5795101" _msthash="409">This will return one result for each author in the database, annotated with their average book rating.</p> <p><font _mstmutation="1" _msttexthash="2658916" _msthash="410">However, the result will be slightly different if you use a  clause:</font><code>values()</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Author.objects.values("name").annotate(average_rating=Avg("book__rating"))
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="330"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p _msttexthash="55937323" _msthash="411">In this example, the authors will be grouped by name, so you will only get an annotated result for each <em>unique</em> author name. This means if you have two authors with the same name, their results will be merged into a single result in the output of the query; the average will be computed as the average over the books written by both authors.</p> <section id="s-order-of-annotate-and-values-clauses"> <h4 id="order-of-annotate-and-values-clauses"><font _mstmutation="1" _msttexthash="350831" _msthash="412">Order of  and  clauses</font><code>annotate()</code><code>values()</code></h4> <p><font _mstmutation="1" _msttexthash="18922397" _msthash="413">As with the  clause, the order in which  and  clauses are applied to a query is significant. If the  clause precedes the , the annotation will be computed using the grouping described by the  clause.</font><code>filter()</code><code>annotate()</code><code>values()</code><code>values()</code><code>annotate()</code><code>values()</code></p> <p><font _mstmutation="1" _msttexthash="18116891" _msthash="414">However, if the  clause precedes the  clause, the annotations will be generated over the entire query set. In this case, the  clause only constrains the fields that are generated on output.</font><code>annotate()</code><code>values()</code><code>values()</code></p> <p><font _mstmutation="1" _msttexthash="3709953" _msthash="415">For example, if we reverse the order of the  and  clause from our previous example:</font><code>values()</code><code>annotate()</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Author.objects.annotate(average_rating=Avg("book__rating")).values(
...     "name", "average_rating"
... )
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="331"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="18399420" _msthash="416">This will now yield one unique result for each author; however, only the author’s name and the  annotation will be returned in the output data.</font><code>average_rating</code></p> <p><font _mstmutation="1" _msttexthash="11805781" _msthash="417">You should also note that  has been explicitly included in the list of values to be returned. This is required because of the ordering of the  and  clause.</font><code>average_rating</code><code>values()</code><code>annotate()</code></p> <p><font _mstmutation="1" _msttexthash="21229598" _msthash="418">If the  clause precedes the  clause, any annotations will be automatically added to the result set. However, if the  clause is applied after the  clause, you need to explicitly include the aggregate column.</font><code>values()</code><code>annotate()</code><code>values()</code><code>annotate()</code></p> </section> <section id="s-interaction-with-order-by"> <h4 id="aggregation-ordering-interaction"><font _mstmutation="1" _msttexthash="294268" _msthash="419">Interaction with </font><code>order_by()</code>
</h4> <p><font _mstmutation="1" _msttexthash="88589852" _msthash="420">Fields that are mentioned in the  part of a queryset are used when selecting the output data, even if they are not otherwise specified in the  call. These extra fields are used to group “like” results together and they can make otherwise identical result rows appear to be separate. This shows up, particularly, when counting things.</font><code>order_by()</code><code>values()</code></p> <p _msttexthash="1707875" _msthash="421">By way of example, suppose you have a model like this:</p> <pre data-language="python" class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models


<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span><span class="token punctuation">)</span>
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="332"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="6185062" _msthash="422">If you want to count how many times each distinct  value appears in an ordered queryset, you might try this:</font><code>data</code></p> <pre data-language="python" class="language-python">items <span class="token operator">=</span> Item<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>
<span class="token comment"># Warning: not quite correct!</span>
items<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>Count<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="333"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="80577354" _msthash="423">…which will group the  objects by their common  values and then count the number of  values in each group. Except that it won’t quite work. The ordering by  will also play a part in the grouping, so this query will group by distinct  pairs, which isn’t what you want. Instead, you should construct this queryset:</font><code>Item</code><code>data</code><code>id</code><code>name</code><code>(data, name)</code></p> <pre data-language="python" class="language-python">items<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>Count<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token punctuation">)</span>
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="334"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p><font _mstmutation="1" _msttexthash="11827465" _msthash="424">…clearing any ordering in the query. You could also order by, say,  without any harmful effects, since that is already playing a role in the query.</font><code>data</code></p> <p><font _mstmutation="1" _msttexthash="77694916" _msthash="425">This behavior is the same as that noted in the queryset documentation for <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#django.db.models.query.QuerySet.distinct" title="django.db.models.query.QuerySet.distinct" _mstmutation="1"><code>distinct()</code></a> and the general rule is the same: normally you won’t want extra columns playing a part in the result, so clear out the ordering, or at least make sure it’s restricted only to those fields you also select in a  call.</font><code>values()</code></p> <div class="admonition note"> <p class="admonition-title" _msttexthash="45344" _msthash="426">Note</p> <p><font _mstmutation="1" _msttexthash="94075735" _msthash="427">You might reasonably ask why Django doesn’t remove the extraneous columns for you. The main reason is consistency with  and other places: Django <strong _mstmutation="1">never</strong> removes ordering constraints that you have specified (and we can’t change those other methods’ behavior, as that would violate our <a class="reference internal" href="https://docs.djangoproject.com/en/5.2/misc/api-stability/" _mstmutation="1"><span class="doc">API stability</span></a> policy).</font><code>distinct()</code></p> </div> </section> </section> <section id="s-aggregating-annotations"> <h3 id="aggregating-annotations" _msttexthash="536887" _msthash="428">Aggregating annotations</h3> <p><font _mstmutation="1" _msttexthash="17595838" _msthash="429">You can also generate an aggregate on the result of an annotation. When you define an  clause, the aggregates you provide can reference any alias defined as part of an  clause in the query.</font><code>aggregate()</code><code>annotate()</code></p> <p _msttexthash="21926021" _msthash="430">For example, if you wanted to calculate the average number of authors per book you first annotate the set of books with the author count, then aggregate that author count, referencing the annotation field:</p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; from django.db.models import Avg, Count
&gt;&gt;&gt; Book.objects.annotate(num_authors=Count("authors")).aggregate(Avg("num_authors"))
{'num_authors__avg': 1.66}
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="335"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> </section> <section id="s-aggregating-on-empty-querysets-or-groups"> <h3 id="aggregating-on-empty-querysets-or-groups" _msttexthash="1210898" _msthash="431">Aggregating on empty querysets or groups</h3> <p><font _mstmutation="1" _msttexthash="25767976" _msthash="432">When an aggregation is applied to an empty queryset or grouping, the result defaults to its <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#aggregate-default" _mstmutation="1"><span class="std std-ref">default</span></a> parameter, typically . This behavior occurs because aggregate functions return  when the executed query returns no rows.</font><code>None</code><code>NULL</code></p> <p><font _mstmutation="1" _msttexthash="21486179" _msthash="433">You can specify a return value by providing the <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#aggregate-default" _mstmutation="1"><span class="std std-ref">default</span></a> argument for most aggregations. However, since <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#django.db.models.Count" title="django.db.models.Count" _mstmutation="1"><code>Count</code></a> does not support the <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#aggregate-default" _mstmutation="1"><span class="std std-ref">default</span></a> argument, it will always return  for empty querysets or groups.</font><code>0</code></p> <p><font _mstmutation="1" _msttexthash="18083429" _msthash="434">For example, assuming that no book contains <em _mstmutation="1">web</em> in its name, calculating the total price for this book set would return  since there are no matching rows to compute the <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#django.db.models.Sum" title="django.db.models.Sum" _mstmutation="1"><code>Sum</code></a> aggregation on:</font><code>None</code></p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; from django.db.models import Sum
&gt;&gt;&gt; Book.objects.filter(name__contains="web").aggregate(Sum("price"))
{"price__sum": None}
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="336"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p _msttexthash="7459062" _msthash="435">However, the <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#aggregate-default"><span class="std std-ref">default</span></a> argument can be set when calling <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#django.db.models.Sum" title="django.db.models.Sum"><code>Sum</code></a> to return a different default value if no books can be found:</p> <pre data-language="pycon" class="language-pycon">&gt;&gt;&gt; Book.objects.filter(name__contains="web").aggregate(Sum("price", default=0))
{"price__sum": Decimal("0")}
<button type="button" class="_pre-clip" title="Copy to clipboard" aria-label="Copy to clipboard" _msthidden="A" _mstaria-label="289068" _msthash="337"><svg><use xlink:href="#icon-copy"></use></svg></button></pre> <p _msttexthash="5918640" _msthash="436">Under the hood, the <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/querysets#aggregate-default"><span class="std std-ref">default</span></a> argument is implemented by wrapping the aggregate function with <a class="reference internal" href="https://devdocs.io/django~5.2/ref/models/database-functions#django.db.models.functions.Coalesce" title="django.db.models.functions.Coalesce"><code>Coalesce</code></a>.</p> </section> </section> </section><div class="_attribution">
  <p class="_attribution-p"><font _mstmutation="1" _msttexthash="12835953" _msthash="437">
    © Django Software Foundation and individual contributors<br _mstmutation="1">Licensed under the BSD License.<br _mstmutation="1">
    <a href="https://docs.djangoproject.com/en/5.2/topics/db/aggregation/" class="_attribution-link" _mstmutation="1">https://docs.djangoproject.com/en/5.2/topics/db/aggregation/</a></font>
  </p>
</div>
</div></main>
  </div>
  <form class="_settings" id="settings" _msthidden="5">
    <div class="_header" _msthidden="5">
      <button type="button" aria-label="Back" class="_settings-btn _settings-btn-back" data-back="" _msthidden="1" _mstaria-label="41587" _msthash="248">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg><font _mstmutation="1" _msttexthash="41587" _msthidden="1" _msthash="249"> Back
      </font></button>
      <button type="submit" class="_settings-btn _settings-btn-save" _msthidden="1">
        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg><font _mstmutation="1" _msttexthash="62010" _msthidden="1" _msthash="250"> Apply
      </font></button>
      <nav class="_settings-tabs" _msthidden="2">
        <button type="button" class="_settings-tab active" data-tab="doc-picker" hidden="" _msttexthash="44265" _msthidden="1" _msthash="251">Docs</button><button type="button" class="_settings-tab" data-tab="settings" hidden="" _msttexthash="117221" _msthidden="1" _msthash="252">Settings</button>
      </nav>
    </div>
    <div class="_sidebar" tabindex="-1"></div>
  </form>
<div class="_resizer" draggable="true"></div></div>
<svg style="display:none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
    <symbol id="icon-search" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></symbol>
    <symbol id="icon-dir" viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"></path></symbol>
    <symbol id="icon-close" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></symbol>
    <symbol id="icon-copy" viewBox="0 0 14 16"><path d="M2 13h4v1H2v-1zm5-6H2v1h5V7zm2 3V8l-3 3 3 3v-2h5v-2H9zM4.5 9H2v1h2.5V9zM2 12h2.5v-1H2v1zm9 1h1v2c-.02.28-.11.52-.3.7-.19.18-.42.28-.7.3H1c-.55 0-1-.45-1-1V4c0-.55.45-1 1-1h3c0-1.11.89-2 2-2 1.11 0 2 .89 2 2h3c.55 0 1 .45 1 1v5h-1V6H1v9h10v-2zM2 5h8c0-.55-.45-1-1-1H8c-.55 0-1-.45-1-1s-.45-1-1-1-1 .45-1 1-.45 1-1 1H3c-.55 0-1 .45-1 1z"></path></symbol>
    <symbol id="icon-external-link" viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"></path></symbol>
  </defs>
</svg>
<script src="./Django 5.2 _ Aggregation — DevDocs_files/application-a41e4614fb3675f0df46362f73344b314779716528220fa68a3d6dcd8e46385f.js.descargar" type="text/javascript"></script>


</body></html>